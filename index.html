<title>Typing Practice Zone ⌨</title>
<style>
    :root {
        color-scheme: light dark;
        --green: #00b755;
        --yellow: #daaf38;
        --red: #ca4754;
        --black: #222;
        --gray: #999;

        --green-light: #3dbb77;
        --yellow-light: #f0b854;
        --red-light: #e37c8a;
        --black-light: #f3f3f3;
        --gray-light: #777777;
    }

    body {
        background: var(--black);
        transition: background .2s ease-in-out;
        font-family: Menlo, monospace;
        display: grid;
        padding: 32px;
        justify-content: center;
        padding-top: 32px;
        padding: 16px;
        position: relative;
    }

    #sun-icon {
        display: none;
        position: absolute;
        color: var(--black);
    }

    #moon-icon {
        position: absolute;
        color: var(--gray);
    }

    body.light-mode {
        background-color: var(--black-light);

        &.light-mode #moon-icon {
            display: none;
        }

        &.light-mode #sun-icon {
            display: block;
        }

        &.light-mode time {
            color: var(--yellow-light);
        }

        &.light-mode h2 {
            color: var(--black);
            opacity: .8;
        }

        &.light-mode h3 {
            color: var(--yellow-light);
        }

        &.light-mode x-letter {
            color: var(--black);
            opacity: .8;

            &.correct {
                color: var(--green);
            }

            &.incorrect {
                color: var(--red);
            }
        }

        &.light-mode x-word.marked {
            border-color: var(--red-light);
        }

        & #reload-button {
            opacity: .8;

            &:hover{
                background: var(--gray);
            }

            & svg{
                color: var(--black);
            }
        }
    }

    main {
        display: flex;
        justify-content: center;
        align-items: center;
    }

    section {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 4px;
        max-width: 800px;
    }

    time {
        color: var(--yellow);
        font-size: 50px;
    }

    input {
        z-index: -999;
        position: absolute;
        top: 0;
        left: 0;
        pointer-events: none;
        opacity: 0;
    }

    p {
        display: flex;
        flex-wrap: wrap;
        gap: 3px 8px;
        margin: 0;
    }

    x-letter {
        color: var(--gray);
        position: relative;
        font-size: 20px;

        &.active::before {
            content: '|';
            color: var(--yellow);
            font-size: 20px;
            position: absolute;
            left: -58%;
            animation: 1s blink infinite ease-in-out;
        }

        &.active.is-last::before {
            left: 65%;
        }

        &.correct {
            color: var(--green);
        }

        &.incorrect {
            color: var(--red);
        }
    }

    x-word {
        border-bottom: 1.5px solid transparent;
        transition: border-color 0.3s ease-in-out;

        &.marked {
            border-color: var(--red);
        }
    }

    @keyframes blink {

        0%,
        25% {
            opacity: 1;
        }

        75% {
            opacity: 0;
        }
    }

    #home {
        display: none;
    }

    #game {
        display: flex;
    }

    #results {
        display: none;
    }

    h2 {
        font-weight: 400;
        opacity: .4;
        margin: 0;
        font-size: 26px;
        color: var(--black-light);
    }

    h3 {
        font-weight: 400;
        margin: 0;
        font-size: 34px;
        color: var(--yellow);
    }

    #reload-button {
        background: transparent;
        border: 0;
        margin-top: 32px;
        padding: 10px;
        opacity: .4;
        display: inline-block;
        transition: background 0.3s ease-in-out, opacity 0.3s ease-in-out, scale 0.3s ease-in-out;
        cursor: pointer;
        color-scheme: light dark;
        border-radius: 16px;

        &:hover {
            background: #444;
            opacity: 1;
            scale: 110%;
        }

        & > svg{
            color: var(--black-light);
        }
    }

    .div-toggle-mode {
        display: flex;
        justify-content: center;
        align-items: center;
        position: absolute;
        top: 2vh;
        right: 2vw;
    }

    #toggle-mode-button {
        background: transparent;
        border: 0;
        cursor: pointer;
        border-radius: 16px;
        transition: scale .2s ease-in-out;
        position: relative;
        width: 30px;
        height: 30px;
        display: flex;
        justify-content: center;
        align-items: center;

        &:hover {
            scale: 110%;
        }
    }
</style>

<body>
    <main>
        <div class="div-toggle-mode">
            <button id="toggle-mode-button">
                <svg id="sun-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                    stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                    <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                    <path d="M12 12m-4 0a4 4 0 1 0 8 0a4 4 0 1 0 -8 0" />
                    <path
                        d="M3 12h1m8 -9v1m8 8h1m-9 8v1m-6.4 -15.4l.7 .7m12.1 -.7l-.7 .7m0 11.4l.7 .7m-12.1 -.7l-.7 .7" />
                </svg>
                <svg id="moon-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                    stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                    <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                    <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
                </svg>
            </button>
        </div>
        <section id="home"></section>
        <section id="game">
            <time></time>
            <p></p>
            <input>
        </section>
        <section id="results">
            <h2>Palabras por minuto</h2>
            <h3 id="results-wpm"></h3>

            <h2>Letras Correctas</h2>
            <h3 id="results-letter"></h3>

            <h2>Precisión</h2>
            <h3 id="results-accuracy"></h3>

            <button id="reload-button">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"
                    stroke-linecap="round" stroke-linejoin="round">
                    <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                    <path d="M19.933 13.041a8 8 0 1 1 -9.925 -8.788c3.899 -1 7.935 1.007 9.425 4.747" />
                    <path d="M20 4v5h-5" />
                </svg>
            </button>
        </section>
    </main>
</body>

<script type="module">
    const $time = document.querySelector('time');
    const $paragraph = document.querySelector('p');
    const $input = document.querySelector('input');
    const $game = document.querySelector('#game')
    const $results = document.querySelector('#results')
    const $wpm = $results.querySelector('#results-wpm')
    const $accuracy = $results.querySelector('#results-accuracy')
    const $letters = $results.querySelector('#results-letter')
    const $button = document.querySelector('#reload-button')
    const $toggleModeButton = document.querySelector('#toggle-mode-button');
    const $body = document.body;

    const INITIAL_TIME = 30;
    const url = 'https://raw.githubusercontent.com/javierarce/palabras/master/listado-general.txt';

    $toggleModeButton.addEventListener('click', () => {
        $body.classList.toggle('light-mode');
    });

    const TEXT = 'quick brown fox jumps over the lazy dog and midudev is trying to clone monkey type for fun and profit using vanilla js for the typing test speed';

    let words = [];
    let currentTime = INITIAL_TIME;

    fetchWords();

    async function fetchWords() {
        try {
            const response = await fetch(url);
            const data = await response.text();
            const allWords = data.split('\n');
            const totalWords = allWords.length;
            const randomIndices = [];

            while (randomIndices.length < 200) {
                const index = Math.floor(Math.random() * totalWords);
                if (!randomIndices.includes(index)) {
                    randomIndices.push(index);
                }
            }

            words = randomIndices.map(index => allWords[index]);
            console.log('Palabras cargadas:', words);
            initGame()
        } catch (error) {
            console.error('Error fetching words:', error);
        }
    }


    function getRandomWords(count) {
        const randomWords = [];
        for (let i = 0; i < count; i++) {
            const index = Math.floor(Math.random() * words.length);
            randomWords.push(words.splice(index, 1)[0]);
        }
        return randomWords;
    }

    function initGame() {
        console.log("cargó");
        initEvents();
        $game.style.display = 'flex';
        $results.style.display = 'none';
        $input.value = '';

        currentTime = INITIAL_TIME;

        $time.textContent = currentTime;

        const words = getRandomWords(32); // Obtener palabras aleatorias de forma síncrona

        const wordsHTML = words.map((word, index) => {
            const letters = word.split('');
            return `<x-word>
            ${letters.map(letter => `<x-letter>${letter}</x-letter>`)
                    .join('')
                }
        </x-word>`;
        }).join('');

        $paragraph.innerHTML = wordsHTML;

        const $firstWord = $paragraph.querySelector('x-word');
        $firstWord.classList.add('active');
        $firstWord.querySelector('x-letter').classList.add('active');

        const intervalId = setInterval(() => {
            currentTime--;
            $time.textContent = currentTime;

            if (currentTime === 0) {
                clearInterval(intervalId);
                gameOver();
            }
        }, 1000);
    }

    function initEvents() {
        document.addEventListener('keydown', () => {
            $input.focus()
        })
        $input.addEventListener('keydown', onKeyDown)
        $input.addEventListener('keyup', onKeyUp)
        $button.addEventListener('click', initGame)
    }

    function onKeyDown(event) {
        const $currentWord = $paragraph.querySelector('x-word.active')
        const $currentLetter = $currentWord.querySelector('x-letter.active')

        const { key } = event
        if (key === ' ') {
            event.preventDefault()

            const $nextWord = $currentWord.nextElementSibling
            const $nextLetter = $nextWord.querySelector('x-letter')

            $currentWord.classList.remove('active', 'marked')
            $currentLetter.classList.remove('active')

            $nextWord.classList.add('active')
            $nextLetter.classList.add('active')

            $input.value = ''

            const hasMissedLetters = $currentWord
                .querySelectorAll('x-letter:not(.correct)').length > 0

            const classToAdd = hasMissedLetters ? 'marked' : 'correct'
            $currentWord.classList.add(classToAdd)
        }

        if (key === 'Backspace') {
            const $prevWord = $currentWord.previousElementSibling
            const $prevLetter = $currentLetter.previousElementSibling

            if (!$prevWord && !$prevLetter) {
                event.preventDefault()
                return
            }

            const $wordMarked = $paragraph.querySelector('x-word.marked')

            if ($wordMarked && !$prevLetter) {
                event.preventDefault()
                $prevWord.classList.remove('marked')
                $prevWord.classList.add('active')

                const $letterToGo = $prevWord.querySelector('x-letter:last-child')

                $currentLetter.classList.remove('active')
                $letterToGo.classList.add('active')

                $input.value = [
                    ...$prevWord.querySelectorAll('x-letter.correct, x-letter.incorrect')
                ].map($el => {
                    return $el.classList.contains('correct') ? $el.innerText : '*'
                }).join('')
            }
        }
    }

    function onKeyUp() {
        const $currentWord = $paragraph.querySelector('x-word.active')
        const $currentLetter = $currentWord.querySelector('x-letter.active')

        const currentWord = $currentWord.innerText.trim()
        $input.maxLength = currentWord.length
        console.log({ $value: $input.value, currentWord });

        const $allLetters = $currentWord.querySelectorAll('x-letter')
        $allLetters.forEach($letter => $letter.classList.remove('correct', 'incorrect'))

        $input.value.split('').forEach((char, index) => {
            const $letter = $allLetters[index]
            const letterToCheck = currentWord[index]

            const isCorrect = char === letterToCheck
            const letterClass = isCorrect ? 'correct' : 'incorrect'
            $letter.classList.add(letterClass)
        })

        $currentLetter.classList.remove('active', 'is-last')
        const inputLength = $input.value.length
        const $nextActiveLetter = $allLetters[inputLength]

        if ($nextActiveLetter) {
            $nextActiveLetter.classList.add('active')
        } else {
            $currentLetter.classList.add('active', 'is-last')
        }
    }

    function gameOver() {
        $game.style.display = 'none'
        $results.style.display = 'flex'

        const correctWords = $paragraph.querySelectorAll('x-word.correct').length
        const correctLetters = $paragraph.querySelectorAll('x-letter.correct').length
        const incorrectLetters = $paragraph.querySelectorAll('x-letter.incorrect').length

        const totalLetters = correctLetters + incorrectLetters
        const totalLettersEntered = $paragraph.querySelectorAll('x-letter.correct, x-letter.incorrect').length;

        const accuracy = totalLettersEntered > 0 ? (correctLetters / totalLettersEntered) * 100 : 0;

        const wpm = correctWords * 60 / INITIAL_TIME
        $wpm.textContent = wpm
        $accuracy.textContent = `${accuracy.toFixed(2)}%`
        $letters.textContent = `${correctLetters} / ${totalLetters}`;
    }
</script>